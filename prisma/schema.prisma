// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model TautulliConfig {
  id       Int     @id @default(1)
  ip       String
  port     Int
  apiKey   String
  useSsl   Boolean @default(false)
  rootPath String?
}

model MediaConfig {
  id          Int     @id @default(1)
  tmdbApiKey  String?
  tvdbApiKey  String?
}

model AiConfig {
  id           Int     @id @default(1)
  enabled      Boolean @default(false)
  apiKey       String?
  model        String  @default("gpt-4o")
  instructions String? @default("Analyze the user’s Plex statistics and produce a brutally honest /r/roastme-style roast. Be mean, dry, and sarcastic. No empathy, no disclaimers, no praise unless it is immediately undercut. Treat the stats as evidence of bad habits, questionable taste, avoidance of sleep, commitment issues, nostalgia addiction, or fake “good taste.” If data is missing, infer something unflattering. Write one or two short paragraphs that summarize the user as a person based solely on their viewing behavior. No emojis, no self-reference, no moral lessons. Roast choices and habits only, not protected traits. The result should be funny, uncomfortable, and very shareable.")
}

model AdminUser {
  id           Int    @id @default(autoincrement())
  username     String @unique
  passwordHash String
}

model User {
  id       Int     @id // Tautulli User ID
  username String?
  email    String?
  thumb    String?
  isActive Boolean @default(true)
  
  statsCache       String?  // JSON string of StatsResult
  statsGeneratedAt DateTime?

  loginToken       String?  @unique
  tokenExpiresAt   DateTime?
  
  history  WatchHistory[]
  syncLogs SyncLog[]
}

model WatchHistory {
  id                  Int      @id @default(autoincrement())
  tautulliId          Int?     // row_id from Tautulli (optional as it might not be unique across servers if multiple)
  userId              Int
  user                User     @relation(fields: [userId], references: [id])
  date                DateTime // UNIX timestamp converted
  
  duration            Int      // Seconds
  percentComplete     Int?     // 0-100 (changed to nullable as per instruction)
  mediaType           String   // movie, episode, track
  year                Int?     // Release year
  actors              String?  // Comma separated
  genres              String?  // Comma separated
  rating              Float?
  transcodeDecision   String?
  player              String?
  fileSize            BigInt?
  
  title               String
  parentTitle         String?
  grandparentTitle    String?
  
  ratingKey           String?  // Plex Rating Key
  parentRatingKey     String?
  grandparentRatingKey String?
  
  fullTitle           String?  // Constructed title for display

  @@index([userId])
  @@index([date])
}

model SyncLog {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  date      DateTime // Represents the DAY (YYYY-MM-DD 00:00:00)
  completed Boolean  @default(false)

  @@unique([userId, date])
}
